
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>15 任务 - 在后台做繁重的工作 · PYQGIS开发者手册-中文</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="llc">
        
        
    
    <link rel="stylesheet" href="style.css">

    
            
                
                <link rel="stylesheet" href="gitbook-plugin-search-pro/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook-plugin-chapter-fold/chapter-fold.css">
                
            
                
                <link rel="stylesheet" href="gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="gitbook-plugin-code/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook-plugin-back-to-top-button/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook-plugin-donate/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook-plugin-auto-scroll-table/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook-plugin-lightbox/css/lightbox.min.css">
                
            
                
                <link rel="stylesheet" href="gitbook-plugin-pageview-count/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="15 任务 - 在后台做繁重的工作.html" />
    
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    0 简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="1 引言.html">
            
                <a href="1 引言.html">
            
                    
                    1 引言
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="1 引言.html">
            
                <a href="1 引言.html#11-在python控制台中编写脚本">
            
                    
                    1.1 在Python控制台中编写脚本
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="1 引言.html">
            
                <a href="1 引言.html#12-python插件">
            
                    
                    1.2 Python插件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="1 引言.html">
            
                <a href="1 引言.html#13-qgis启动时运行python代码">
            
                    
                    1.3 QGIS启动时运行Python代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="1 引言.html">
            
                <a href="1 引言.html#14-python应用程序">
            
                    
                    1.4 Python应用程序
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="1 引言.html">
            
                <a href="1 引言.html#15-关于pyqt和sip的技术说明">
            
                    
                    1.5 关于PyQt和SIP的技术说明
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="2 加载项目.html">
            
                <a href="2 加载项目.html">
            
                    
                    2 加载项目
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="2 加载项目.html">
            
                <a href="2 加载项目.html#21-解决错误路径">
            
                    
                    2.1 解决错误路径
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="3 加载图层.html">
            
                <a href="3 加载图层.html">
            
                    
                    3 加载图层
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="3 加载图层.html">
            
                <a href="3 加载图层.html#31-矢量图层">
            
                    
                    3.1 矢量图层
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="3 加载图层.html">
            
                <a href="3 加载图层.html#32-栅格图层">
            
                    
                    3.2 栅格图层
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="3 加载图层.html">
            
                <a href="3 加载图层.html#33-qgsproject-实例">
            
                    
                    3.3 QgsProject 实例
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="4 访问图层目录树.html">
            
                <a href="4 访问图层目录树.html">
            
                    
                    4 访问图层目录树
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="4 访问图层目录树.html">
            
                <a href="4 访问图层目录树.html#41-qgsproject类">
            
                    
                    4.1 QgsProject类
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="4 访问图层目录树.html">
            
                <a href="4 访问图层目录树.html#42-qgslayertreegroup类">
            
                    
                    4.2 QgsLayerTreeGroup类
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="5 使用栅格图层.html">
            
                <a href="5 使用栅格图层.html">
            
                    
                    5 使用栅格图层
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="5 使用栅格图层.html">
            
                <a href="5 使用栅格图层.html#51-图层细节">
            
                    
                    5.1 图层细节
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="5 使用栅格图层.html">
            
                <a href="5 使用栅格图层.html#52-渲染">
            
                    
                    5.2 渲染
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="5 使用栅格图层.html">
            
                <a href="5 使用栅格图层.html#53-查询值">
            
                    
                    5.3 查询值
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="6 使用矢量图层.html">
            
                <a href="6 使用矢量图层.html">
            
                    
                    6 使用矢量图层
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="6 使用矢量图层.html">
            
                <a href="6 使用矢量图层.html#61-检索相关属性信息">
            
                    
                    6.1 检索相关属性信息
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="6 使用矢量图层.html">
            
                <a href="6 使用矢量图层.html#62-遍历矢量图层">
            
                    
                    6.2 遍历矢量图层
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="6 使用矢量图层.html">
            
                <a href="6 使用矢量图层.html#63-选择要素">
            
                    
                    6.3 选择要素
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="6 使用矢量图层.html">
            
                <a href="6 使用矢量图层.html#64-修改矢量图层">
            
                    
                    6.4 修改矢量图层
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.5" data-path="6 使用矢量图层.html">
            
                <a href="6 使用矢量图层.html#65-使用空间索引">
            
                    
                    6.5 使用空间索引
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.6" data-path="6 使用矢量图层.html">
            
                <a href="6 使用矢量图层.html#66-qgsvectorlayerutils类">
            
                    
                    6.6 QgsVectorLayerUtils类
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.7" data-path="6 使用矢量图层.html">
            
                <a href="6 使用矢量图层.html#67-创建矢量图层">
            
                    
                    6.7 创建矢量图层
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.8" data-path="6 使用矢量图层.html">
            
                <a href="6 使用矢量图层.html#68-矢量图层的外观（符号系统）">
            
                    
                    6.8 矢量图层的外观（符号系统）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.9" data-path="6 使用矢量图层.html">
            
                <a href="6 使用矢量图层.html#69-更多话题">
            
                    
                    6.9 更多话题
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="7 几何处理.html">
            
                <a href="7 几何处理.html">
            
                    
                    7 几何处理
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="7 几何处理.html">
            
                <a href="7 几何处理.html#71-几何构造">
            
                    
                    7.1 几何构造
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="7 几何处理.html">
            
                <a href="7 几何处理.html#72-访问几何">
            
                    
                    7.2 访问几何
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="7 几何处理.html">
            
                <a href="7 几何处理.html#73-几何谓词与操作">
            
                    
                    7.3 几何谓词与操作
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="8 投影支持.html">
            
                <a href="8 投影支持.html">
            
                    
                    8 投影支持
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="8 投影支持.html">
            
                <a href="8 投影支持.html#81-坐标参考系统">
            
                    
                    8.1 坐标参考系统
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="8 投影支持.html">
            
                <a href="8 投影支持.html#82-坐标参考系统转换">
            
                    
                    8.2 坐标参考系统转换
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="9 使用地图画布.html">
            
                <a href="9 使用地图画布.html">
            
                    
                    9 使用地图画布
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1" data-path="9 使用地图画布.html">
            
                <a href="9 使用地图画布.html#91-嵌入地图画布">
            
                    
                    9.1 嵌入地图画布
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2" data-path="9 使用地图画布.html">
            
                <a href="9 使用地图画布.html#92-橡皮条和顶点标记">
            
                    
                    9.2 橡皮条和顶点标记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.3" data-path="9 使用地图画布.html">
            
                <a href="9 使用地图画布.html#93-在画布中使用地图工具">
            
                    
                    9.3 在画布中使用地图工具
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.4" data-path="9 使用地图画布.html">
            
                <a href="9 使用地图画布.html#94-编写自定义地图工具">
            
                    
                    9.4 编写自定义地图工具
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.5" data-path="9 使用地图画布.html">
            
                <a href="9 使用地图画布.html#95-编写自定义地图画布项">
            
                    
                    9.5 编写自定义地图画布项
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="10 地图渲染和打印.html">
            
                <a href="10 地图渲染和打印.html">
            
                    
                    10 地图渲染和打印
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1" data-path="10 地图渲染和打印.html">
            
                <a href="10 地图渲染和打印.html#101-简单的渲染">
            
                    
                    10.1 简单的渲染
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2" data-path="10 地图渲染和打印.html">
            
                <a href="10 地图渲染和打印.html#102-使用不同的crs渲染图层">
            
                    
                    10.2 使用不同的CRS渲染图层
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.3" data-path="10 地图渲染和打印.html">
            
                <a href="10 地图渲染和打印.html#103-使用打印布局输出">
            
                    
                    10.3 使用打印布局输出
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="11 表达式，过滤和计算值.html">
            
                <a href="11 表达式，过滤和计算值.html">
            
                    
                    11 表达式，过滤和计算值
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.12.1" data-path="11 表达式，过滤和计算值.html">
            
                <a href="11 表达式，过滤和计算值.html#111-解析表达式">
            
                    
                    11.1 解析表达式
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.2" data-path="11 表达式，过滤和计算值.html">
            
                <a href="11 表达式，过滤和计算值.html#112-评估表达式">
            
                    
                    11.2 评估表达式
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.3" data-path="11 表达式，过滤和计算值.html">
            
                <a href="11 表达式，过滤和计算值.html#113-处理异常错误">
            
                    
                    11.3 处理异常错误
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="12 读取和存储设置.html">
            
                <a href="12 读取和存储设置.html">
            
                    
                    12 读取和存储设置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14" data-path="13 与用户通信.html">
            
                <a href="13 与用户通信.html">
            
                    
                    13 与用户通信
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.14.1" data-path="13 与用户通信.html">
            
                <a href="13 与用户通信.html#131-显示消息">
            
                    
                    13.1 显示消息
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.2" data-path="13 与用户通信.html">
            
                <a href="13 与用户通信.html#132-显示进度">
            
                    
                    13.2 显示进度
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.3" data-path="13 与用户通信.html">
            
                <a href="13 与用户通信.html#133-日志">
            
                    
                    13.3 日志
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.15" data-path="14 认证基础.html">
            
                <a href="14 认证基础.html">
            
                    
                    14 认证基础
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.15.1" data-path="14 认证基础.html">
            
                <a href="14 认证基础.html#141-介绍">
            
                    
                    14.1 介绍
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.2" data-path="14 认证基础.html">
            
                <a href="14 认证基础.html#142-词汇表">
            
                    
                    14.2 词汇表
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.3" data-path="14 认证基础.html">
            
                <a href="14 认证基础.html#143-qgsauthmanager入口">
            
                    
                    14.3 QgsAuthManager入口
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.4" >
            
                <a target="_blank" href="https://docs.qgis.org/testing/en/docs/pyqgis_developer_cookbook/authentication.html#id23">
            
                    
                    14.4 Adapt plugins to use Authentication infrastructure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.5" >
            
                <a target="_blank" href="https://docs.qgis.org/testing/en/docs/pyqgis_developer_cookbook/authentication.html#id24">
            
                    
                    14.5 Authentication GUIs
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter active" data-level="1.16" data-path="15 任务 - 在后台做繁重的工作.html">
            
                <a href="15 任务 - 在后台做繁重的工作.html">
            
                    
                    15 任务 - 在后台做繁重的工作
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.1" data-path="15 任务 - 在后台做繁重的工作.html">
            
                <a href="15 任务 - 在后台做繁重的工作.html#151-引言">
            
                    
                    15.1 引言
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16.2" data-path="15 任务 - 在后台做繁重的工作.html">
            
                <a href="15 任务 - 在后台做繁重的工作.html#152-示例">
            
                    
                    15.2 示例
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.17" data-path="16 开发Python插件.html">
            
                <a href="16 开发Python插件.html">
            
                    
                    16 开发Python插件
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.17.1" data-path="16 开发Python插件.html">
            
                <a href="16 开发Python插件.html#161-构建python插件">
            
                    
                    16.1 构建Python插件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.2" data-path="16 开发Python插件.html">
            
                <a href="16 开发Python插件.html#162-代码片段">
            
                    
                    16.2 代码片段
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.3" data-path="16 开发Python插件.html">
            
                <a href="16 开发Python插件.html#163-使用插件图层">
            
                    
                    16.3 使用插件图层
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.4" data-path="16 开发Python插件.html">
            
                <a href="16 开发Python插件.html#164-编码与调试">
            
                    
                    16.4 编码与调试
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.5" data-path="16 开发Python插件.html">
            
                <a href="16 开发Python插件.html#165-发布你的插件">
            
                    
                    16.5 发布你的插件
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.18" data-path="17 编写处理插件.html">
            
                <a href="17 编写处理插件.html">
            
                    
                    17 编写处理插件
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.18.1" data-path="17 编写处理插件.html">
            
                <a href="17 编写处理插件.html#171-从头开始创建">
            
                    
                    17.1 从头开始创建
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.18.2" data-path="17 编写处理插件.html">
            
                <a href="17 编写处理插件.html#172-更新插件">
            
                    
                    17.2 更新插件
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.19" data-path="18 网络分析库.html">
            
                <a href="18 网络分析库.html">
            
                    
                    18 网络分析库
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.20" data-path="19 QGIS Server Python插件.html">
            
                <a href="19 QGIS Server Python插件.html">
            
                    
                    19 QGIS Server Python插件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.21" data-path="20 PyQGIS速查表.html">
            
                <a href="20 PyQGIS速查表.html">
            
                    
                    20 PyQGIS速查表
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.21.1" data-path="20 PyQGIS速查表.html">
            
                <a href="20 PyQGIS速查表.html#201-用户接口">
            
                    
                    20.1 用户接口
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.21.2" data-path="20 PyQGIS速查表.html">
            
                <a href="20 PyQGIS速查表.html#202-设置">
            
                    
                    20.2 设置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.21.3" data-path="20 PyQGIS速查表.html">
            
                <a href="20 PyQGIS速查表.html#203-工具栏">
            
                    
                    20.3 工具栏
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.21.4" data-path="20 PyQGIS速查表.html">
            
                <a href="20 PyQGIS速查表.html#204-菜单">
            
                    
                    20.4 菜单
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.21.5" data-path="20 PyQGIS速查表.html">
            
                <a href="20 PyQGIS速查表.html#205-画布">
            
                    
                    20.5 画布
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.21.6" data-path="20 PyQGIS速查表.html">
            
                <a href="20 PyQGIS速查表.html#206-图层">
            
                    
                    20.6 图层
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.21.7" data-path="20 PyQGIS速查表.html">
            
                <a href="20 PyQGIS速查表.html#207-目录">
            
                    
                    20.7 目录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.21.8" data-path="20 PyQGIS速查表.html">
            
                <a href="20 PyQGIS速查表.html#208-高级目录">
            
                    
                    20.8 高级目录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.21.9" data-path="20 PyQGIS速查表.html">
            
                <a href="20 PyQGIS速查表.html#209-处理算法">
            
                    
                    20.9 处理算法
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.21.10" data-path="20 PyQGIS速查表.html">
            
                <a href="20 PyQGIS速查表.html#2010-装饰">
            
                    
                    20.10 装饰
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.21.11" data-path="20 PyQGIS速查表.html">
            
                <a href="20 PyQGIS速查表.html#2011-创作者">
            
                    
                    20.11 创作者
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.21.12" data-path="20 PyQGIS速查表.html">
            
                <a href="20 PyQGIS速查表.html#2012-来源">
            
                    
                    20.12 来源
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            本书使用 GitBook 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >15 任务 - 在后台做繁重的工作</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <p>&#x672C;&#x8282;&#x4EE3;&#x7801;&#x7247;&#x6BB5;&#x9700;&#x5BFC;&#x5165;&#x4EE5;&#x4E0B;&#x6A21;&#x5757;&#xFF1A;</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> qgis.core <span class="hljs-keyword">import</span> (
  QgsProcessingContext,
  QgsTaskManager,
  QgsTask,
  QgsProcessingAlgRunnerTask,
  Qgis,
  QgsProcessingFeedback,
  QgsApplication,
  QgsMessageLog,
)
</code></pre>
<h1 id="15-&#x4EFB;&#x52A1;---&#x5728;&#x540E;&#x53F0;&#x505A;&#x7E41;&#x91CD;&#x7684;&#x5DE5;&#x4F5C;">15 &#x4EFB;&#x52A1; - &#x5728;&#x540E;&#x53F0;&#x505A;&#x7E41;&#x91CD;&#x7684;&#x5DE5;&#x4F5C;</h1>
<h2 id="151-&#x5F15;&#x8A00;">15.1 &#x5F15;&#x8A00;</h2>
<p>&#x4F7F;&#x7528;&#x7EBF;&#x7A0B;&#x7684;&#x540E;&#x53F0;&#x5904;&#x7406;&#xFF0C;&#x662F;&#x5728;&#x8FDB;&#x884C;&#x7E41;&#x91CD;&#x5904;&#x7406;&#x65F6;&#x4FDD;&#x6301;&#x7528;&#x6237;&#x754C;&#x9762;&#x54CD;&#x5E94;&#x7684;&#x4E00;&#x79CD;&#x65B9;&#x5F0F;&#x3002;&#x4EFB;&#x52A1;&#x53EF;&#x7528;&#x4E8E;&#x5728;QGIS&#x4E2D;&#x5B9E;&#x73B0;&#x7EBF;&#x7A0B;&#x3002;</p>
<p>&#x4EFB;&#x52A1;&#xFF08;<a href="https://qgis.org/pyqgis/master/core/QgsTask.html#qgis.core.QgsTask" target="_blank"><code>QgsTask</code></a>&#xFF09;&#x662F;&#x5728;&#x540E;&#x53F0;&#x6267;&#x884C;&#x4EE3;&#x7801;&#x7684;&#x5BB9;&#x5668;&#xFF0C;&#x4EFB;&#x52A1;&#x7BA1;&#x7406;&#xFF08;<a href="https://qgis.org/pyqgis/master/core/QgsTaskManager.html#qgis.core.QgsTaskManager" target="_blank"><code>QgsTaskManager</code></a>&#xFF09;&#x7528;&#x4E8E;&#x63A7;&#x5236;&#x4EFB;&#x52A1;&#x7684;&#x8FD0;&#x884C;&#x3002;&#x8FD9;&#x4E9B;&#x7C7B;&#x901A;&#x8FC7;&#x63D0;&#x4F9B;&#x4FE1;&#x53F7;&#x3001;&#x8FDB;&#x5EA6;&#x62A5;&#x544A;&#x548C;&#x540E;&#x53F0;&#x8FDB;&#x7A0B;&#x72B6;&#x6001;&#x8BBF;&#x95EE;&#x673A;&#x5236;&#xFF0C;&#x7B80;&#x5316;&#x4E86;QGIS&#x4E2D;&#x7684;&#x540E;&#x53F0;&#x5904;&#x7406;&#x3002;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x5B50;&#x4EFB;&#x52A1;&#x5BF9;&#x4EFB;&#x52A1;&#x8FDB;&#x884C;&#x5206;&#x7EC4;&#x3002;&#x5168;&#x5C40;&#x4EFB;&#x52A1;&#x7BA1;&#x7406;&#x5668;&#xFF08;<a href="https://qgis.org/pyqgis/master/core/QgsApplication.html#qgis.core.QgsApplication.taskManager" target="_blank"><code>QgsApplication.taskManager()</code></a>&#xFF09;&#x901A;&#x5E38;&#x88AB;&#x4F7F;&#x7528;&#x3002;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x4F60;&#x7684;&#x4EFB;&#x52A1;&#x53EF;&#x80FD;&#x4E0D;&#x662F;&#x7531;&#x4EFB;&#x52A1;&#x7BA1;&#x7406;&#x5668;&#x63A7;&#x5236;&#x7684;&#x552F;&#x4E00;&#x4EFB;&#x52A1;&#x3002;</p>
<p>&#x6709;&#x51E0;&#x79CD;&#x65B9;&#x6CD5;&#x53EF;&#x4EE5;&#x521B;&#x5EFA;QGIS&#x4EFB;&#x52A1;&#xFF1A;</p>
<ul>
<li><p>&#x901A;&#x8FC7;&#x6269;&#x5C55;<a href="https://qgis.org/pyqgis/master/core/QgsTask.html#qgis.core.QgsTask" target="_blank"><code>QgsTask</code></a>&#x521B;&#x5EFA;&#x81EA;&#x5DF1;&#x7684;&#x4EFB;&#x52A1;</p>
<pre><code class="lang-python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SpecialisedTask</span><span class="hljs-params">(QgsTask)</span>:</span>
    <span class="hljs-keyword">pass</span>
</code></pre>
</li>
<li><p>&#x4ECE;&#x51FD;&#x6570;&#x521B;&#x5EFA;&#x4EFB;&#x52A1;</p>
<pre><code class="lang-python">QgsTask.fromFunction(<span class="hljs-string">u&apos;heavy function&apos;</span>, heavyFunction,onfinished=workdone)
</code></pre>
</li>
<li><p>&#x4ECE;&#x5904;&#x7406;&#x7B97;&#x6CD5;&#x521B;&#x5EFA;&#x4EFB;&#x52A1;</p>
<pre><code class="lang-python">params = dict()
context = QgsProcessingContext()
feedback = QgsProcessingFeedback()

buffer_alg = QgsApplication.instance().processingRegistry().algorithmById(<span class="hljs-string">&apos;native:buffer&apos;</span>)
task = QgsProcessingAlgRunnerTask(buffer_alg, params, context,feedback)
</code></pre>
</li>
</ul>
<hr>
<p><strong>&#x8B66;&#x544A;:</strong> &#x4EFB;&#x4F55;&#x540E;&#x53F0;&#x4EFB;&#x52A1;&#xFF08;&#x65E0;&#x8BBA;&#x5982;&#x4F55;&#x521B;&#x5EFA;&#xFF09;&#x90FD;&#x4E0D;&#x5F97;&#x6267;&#x884C;&#x4EFB;&#x4F55;&#x57FA;&#x4E8E;GUI&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x4F8B;&#x5982;&#x521B;&#x5EFA;&#x65B0;&#x7A97;&#x53E3;&#x63A7;&#x4EF6;&#x6216;&#x4E0E;&#x73B0;&#x6709;&#x7A97;&#x53E3;&#x63A7;&#x4EF6;&#x4EA4;&#x4E92;&#x3002;&#x53EA;&#x80FD;&#x4ECE;&#x4E3B;&#x7EBF;&#x7A0B;&#x8BBF;&#x95EE;&#x6216;&#x4FEE;&#x6539;Qt&#x63A7;&#x4EF6;&#x3002;&#x5C1D;&#x8BD5;&#x4ECE;&#x540E;&#x53F0;&#x7EBF;&#x7A0B;&#x4F7F;&#x7528;&#x5B83;&#x4EEC;&#x5C06;&#x5BFC;&#x81F4;&#x5D29;&#x6E83;&#x3002;</p>
<hr>
<p>&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<a href="https://qgis.org/pyqgis/master/core/QgsTask.html#qgis.core.QgsTask" target="_blank"><code>QgsTask</code></a>&#x4E2D;&#x7684;<a href="https://qgis.org/pyqgis/master/core/QgsTask.html#qgis.core.QgsTask.addSubTask" target="_blank"><code>addSubTask</code></a> &#x51FD;&#x6570;&#x6765;&#x63CF;&#x8FF0;&#x4EFB;&#x52A1;&#x4E4B;&#x95F4;&#x7684;&#x4F9D;&#x8D56;&#x5173;&#x7CFB;&#x3002;&#x5F53;&#x58F0;&#x660E;&#x4F9D;&#x8D56;&#x5173;&#x7CFB;&#x65F6;&#xFF0C;&#x4EFB;&#x52A1;&#x7BA1;&#x7406;&#x5668;&#x5C06;&#x81EA;&#x52A8;&#x786E;&#x5B9A;&#x5982;&#x4F55;&#x6267;&#x884C;&#x8FD9;&#x4E9B;&#x4F9D;&#x8D56;&#x5173;&#x7CFB;&#x3002;&#x53EA;&#x8981;&#x6709;&#x53EF;&#x80FD;&#xFF0C;&#x4F9D;&#x8D56;&#x9879;&#x5C06;&#x5E76;&#x884C;&#x6267;&#x884C;&#xFF0C;&#x4EE5;&#x4FBF;&#x5C3D;&#x5FEB;&#x6EE1;&#x8DB3;&#x5B83;&#x4EEC;&#x3002;&#x5982;&#x679C;&#x53D6;&#x6D88;&#x4E86;&#x53E6;&#x4E00;&#x4E2A;&#x4EFB;&#x52A1;&#x6240;&#x4F9D;&#x8D56;&#x7684;&#x4EFB;&#x52A1;&#xFF0C;&#x5219;&#x76F8;&#x5173;&#x4EFB;&#x52A1;&#x4E5F;&#x5C06;&#x88AB;&#x53D6;&#x6D88;&#x3002;&#x5FAA;&#x73AF;&#x4F9D;&#x8D56;&#x53EF;&#x4EE5;&#x9020;&#x6210;&#x6B7B;&#x9501;&#xFF0C;&#x6240;&#x4EE5;&#x8981;&#x5C0F;&#x5FC3;&#x3002;</p>
<p>&#x5982;&#x679C;&#x4EFB;&#x52A1;&#x4F9D;&#x8D56;&#x4E8E;&#x53EF;&#x7528;&#x7684;&#x56FE;&#x5C42;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<a href="https://qgis.org/pyqgis/master/core/QgsTask.html#qgis.core.QgsTask" target="_blank"><code>QgsTask</code></a>&#x4E2D;&#x7684;<a href="https://qgis.org/pyqgis/master/core/QgsTask.html#qgis.core.QgsTask.setDependentLayers" target="_blank"><code>setDependentLayers</code></a> &#x51FD;&#x6570;&#x6765;&#x58F0;&#x660E;&#x3002;&#x5982;&#x679C;&#x4EFB;&#x52A1;&#x6240;&#x4F9D;&#x8D56;&#x7684;&#x56FE;&#x5C42;&#x4E0D;&#x53EF;&#x7528;&#xFF0C;&#x5219;&#x8BE5;&#x4EFB;&#x52A1;&#x5C06;&#x88AB;&#x53D6;&#x6D88;&#x3002;</p>
<p>&#x521B;&#x5EFA;&#x4EFB;&#x52A1;&#x540E;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<a href="https://qgis.org/pyqgis/master/core/QgsTaskManager.html#qgis.core.QgsTaskManager.addTask" target="_blank"><code>addTask</code></a>&#x4EFB;&#x52A1;&#x7BA1;&#x7406;&#x5668;&#x7684;&#x529F;&#x80FD;&#x5B89;&#x6392;&#x4EFB;&#x52A1;&#x8FD0;&#x884C;&#x3002;&#x5411;&#x7BA1;&#x7406;&#x5668;&#x6DFB;&#x52A0;&#x4EFB;&#x52A1;&#x4F1A;&#x81EA;&#x52A8;&#x5C06;&#x8BE5;&#x4EFB;&#x52A1;&#x7684;&#x6240;&#x6709;&#x6743;&#x8F6C;&#x79FB;&#x7ED9;&#x7BA1;&#x7406;&#x5458;&#xFF0C;&#x7BA1;&#x7406;&#x5458;&#x5C06;&#x5728;&#x6267;&#x884C;&#x5B8C;&#x540E;&#x6E05;&#x7406;&#x548C;&#x5220;&#x9664;&#x4EFB;&#x52A1;&#x3002;&#x4EFB;&#x52A1;&#x7684;&#x8C03;&#x5EA6;&#x53D7;&#x4EFB;&#x52A1;&#x4F18;&#x5148;&#x7EA7;&#x7684;&#x5F71;&#x54CD;&#xFF0C;&#x4EFB;&#x52A1;&#x4F18;&#x5148;&#x7EA7;&#x8BBE;&#x7F6E;&#x5728;<a href="https://qgis.org/pyqgis/master/core/QgsTaskManager.html#qgis.core.QgsTaskManager.addTask" target="_blank"><code>addTask</code></a>&#x3002;</p>
<p>&#x4EFB;&#x52A1;&#x7684;&#x72B6;&#x6001;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<a href="https://qgis.org/pyqgis/master/core/QgsTask.html#qgis.core.QgsTask" target="_blank"><code>QgsTask</code></a>&#x3001;<a href="https://qgis.org/pyqgis/master/core/QgsTaskManager.html#qgis.core.QgsTaskManager" target="_blank"><code>QgsTaskManager</code></a>&#x4FE1;&#x53F7;&#x548C;&#x51FD;&#x6570;&#x8FDB;&#x884C;&#x76D1;&#x63A7;&#x3002;</p>
<h2 id="152-&#x793A;&#x4F8B;">15.2 &#x793A;&#x4F8B;</h2>
<h3 id="1521-&#x6269;&#x5C55;qgstask">15.2.1 &#x6269;&#x5C55;QgsTask</h3>
<p>&#x5728;&#x6B64;&#x793A;&#x4F8B;&#x4E2D;&#xFF0C;<code>RandomIntegerSumTask</code>&#x6269;&#x5C55;&#x4E86;<a href="https://qgis.org/pyqgis/master/core/QgsTask.html#qgis.core.QgsTask" target="_blank"><code>QgsTask</code></a>&#xFF0C;&#x5B83;&#x5C06;&#x5728;&#x6307;&#x5B9A;&#x7684;&#x65F6;&#x95F4;&#x6BB5;&#x5185;&#x751F;&#x6210;0&#x5230;500&#x4E4B;&#x95F4;&#x7684;100&#x4E2A;&#x968F;&#x673A;&#x6574;&#x6570;&#x3002;&#x5982;&#x679C;&#x968F;&#x673A;&#x6570;&#x4E3A;42&#xFF0C;&#x5219;&#x4E2D;&#x6B62;&#x4EFB;&#x52A1;&#x5E76;&#x5F15;&#x53D1;&#x5F02;&#x5E38;&#x3002;<code>RandomIntegerSumTask</code>&#xFF08;&#x5E26;&#x5B50;&#x4EFB;&#x52A1;&#xFF09;&#x751F;&#x6210;&#x4E86;&#x51E0;&#x4E2A;&#x5B9E;&#x4F8B;&#x5E76;&#x5C06;&#x5176;&#x6DFB;&#x52A0;&#x5230;&#x4EFB;&#x52A1;&#x7BA1;&#x7406;&#x5668;&#xFF0C;&#x5C55;&#x793A;&#x4E24;&#x79CD;&#x7C7B;&#x578B;&#x7684;&#x4F9D;&#x8D56;&#x9879;&#xFF1A;</p>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> random
<span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> sleep

<span class="hljs-keyword">from</span> qgis.core <span class="hljs-keyword">import</span> (
    QgsApplication, QgsTask, QgsMessageLog,
    )

MESSAGE_CATEGORY = <span class="hljs-string">&apos;RandomIntegerSumTask&apos;</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RandomIntegerSumTask</span><span class="hljs-params">(QgsTask)</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot;This shows how to subclass QgsTask&quot;&quot;&quot;</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, description, duration)</span>:</span>
        super().__init__(description, QgsTask.CanCancel)
        self.duration = duration
        self.total = <span class="hljs-number">0</span>
        self.iterations = <span class="hljs-number">0</span>
        self.exception = <span class="hljs-keyword">None</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">&quot;&quot;&quot;Here you implement your heavy lifting.
        Should periodically test for isCanceled() to gracefully
        abort.
        This method MUST return True or False.
        Raising exceptions will crash QGIS, so we handle them
        internally and raise them in self.finished
        &quot;&quot;&quot;</span>
        QgsMessageLog.logMessage(<span class="hljs-string">&apos;Started task &quot;{}&quot;&apos;</span>.format(
                                     self.description()),
                                 MESSAGE_CATEGORY, Qgis.Info)
        wait_time = self.duration / <span class="hljs-number">100</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">100</span>):
            sleep(wait_time)
            <span class="hljs-comment"># use setProgress to report progress</span>
            self.setProgress(i)
            arandominteger = random.randint(<span class="hljs-number">0</span>, <span class="hljs-number">500</span>)
            self.total += arandominteger
            self.iterations += <span class="hljs-number">1</span>
            <span class="hljs-comment"># check isCanceled() to handle cancellation</span>
            <span class="hljs-keyword">if</span> self.isCanceled():
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">False</span>
            <span class="hljs-comment"># simulate exceptions to show how to abort task</span>
            <span class="hljs-keyword">if</span> arandominteger == <span class="hljs-number">42</span>:
                <span class="hljs-comment"># DO NOT raise Exception(&apos;bad value!&apos;)</span>
                <span class="hljs-comment"># this would crash QGIS</span>
                self.exception = Exception(<span class="hljs-string">&apos;bad value!&apos;</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">False</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">finished</span><span class="hljs-params">(self, result)</span>:</span>
        <span class="hljs-string">&quot;&quot;&quot;
        This function is automatically called when the task has
        completed (successfully or not).
        You implement finished() to do whatever follow-up stuff
        should happen after the task is complete.
        finished is always called from the main thread, so it&apos;s safe
        to do GUI operations and raise Python exceptions here.
        result is the return value from self.run.
        &quot;&quot;&quot;</span>
        <span class="hljs-keyword">if</span> result:
            QgsMessageLog.logMessage(
                <span class="hljs-string">&apos;Task &quot;{name}&quot; completed\n&apos;</span> \
                <span class="hljs-string">&apos;Total: {total} (with {iterations} &apos;</span>\
              <span class="hljs-string">&apos;iterations)&apos;</span>.format(
                  name=self.description(),
                  total=self.total,
                  iterations=self.iterations),
              MESSAGE_CATEGORY, Qgis.Success)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">if</span> self.exception <span class="hljs-keyword">is</span> <span class="hljs-keyword">None</span>:
                QgsMessageLog.logMessage(
                    <span class="hljs-string">&apos;Task &quot;{name}&quot; not successful but without &apos;</span>\
                    <span class="hljs-string">&apos;exception (probably the task was manually &apos;</span>\
                    <span class="hljs-string">&apos;canceled by the user)&apos;</span>.format(
                        name=self.description()),
                    MESSAGE_CATEGORY, Qgis.Warning)
            <span class="hljs-keyword">else</span>:
                QgsMessageLog.logMessage(
                    <span class="hljs-string">&apos;Task &quot;{name}&quot; Exception: {exception}&apos;</span>.format(
                        name=self.description(),
                        exception=self.exception),
                    MESSAGE_CATEGORY, Qgis.Critical)
                <span class="hljs-keyword">raise</span> self.exception
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cancel</span><span class="hljs-params">(self)</span>:</span>
        QgsMessageLog.logMessage(
            <span class="hljs-string">&apos;Task &quot;{name}&quot; was canceled&apos;</span>.format(
                name=self.description()),
            MESSAGE_CATEGORY, Qgis.Info)
        super().cancel()


longtask = RandomIntegerSumTask(<span class="hljs-string">&apos;waste cpu long&apos;</span>, <span class="hljs-number">20</span>)
shorttask = RandomIntegerSumTask(<span class="hljs-string">&apos;waste cpu short&apos;</span>, <span class="hljs-number">10</span>)
minitask = RandomIntegerSumTask(<span class="hljs-string">&apos;waste cpu mini&apos;</span>, <span class="hljs-number">5</span>)
shortsubtask = RandomIntegerSumTask(<span class="hljs-string">&apos;waste cpu subtask short&apos;</span>, <span class="hljs-number">5</span>)
longsubtask = RandomIntegerSumTask(<span class="hljs-string">&apos;waste cpu subtask long&apos;</span>, <span class="hljs-number">10</span>)
shortestsubtask = RandomIntegerSumTask(<span class="hljs-string">&apos;waste cpu subtask shortest&apos;</span>, <span class="hljs-number">4</span>)

<span class="hljs-comment"># Add a subtask (shortsubtask) to shorttask that must run after</span>
<span class="hljs-comment"># minitask and longtask has finished</span>
shorttask.addSubTask(shortsubtask, [minitask, longtask])
<span class="hljs-comment"># Add a subtask (longsubtask) to longtask that must be run</span>
<span class="hljs-comment"># before the parent task</span>
longtask.addSubTask(longsubtask, [], QgsTask.ParentDependsOnSubTask)
<span class="hljs-comment"># Add a subtask (shortestsubtask) to longtask</span>
longtask.addSubTask(shortestsubtask)

QgsApplication.taskManager().addTask(longtask)
QgsApplication.taskManager().addTask(shorttask)
QgsApplication.taskManager().addTask(minitask)
</code></pre>
<h3 id="1522-&#x6765;&#x81EA;&#x51FD;&#x6570;&#x7684;&#x4EFB;&#x52A1;">15.2.2 &#x6765;&#x81EA;&#x51FD;&#x6570;&#x7684;&#x4EFB;&#x52A1;</h3>
<p>&#x4ECE;&#x51FD;&#x6570;&#x521B;&#x5EFA;&#x4EFB;&#x52A1;&#xFF08;<code>doSomething</code>&#xFF09;&#x3002;&#x8BE5;&#x51FD;&#x6570;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x4E3A;<a href="https://qgis.org/pyqgis/master/core/QgsTask.html#qgis.core.QgsTask" target="_blank"><code>QgsTask</code></a> &#x3002;&#x4E00;&#x4E2A;&#x91CD;&#x8981;&#x7684;&#x53C2;&#x6570;&#x662F;<code>on_finished</code>&#xFF0C;&#x5B83;&#x662F;&#x5728;&#x4EFB;&#x52A1;&#x5B8C;&#x6210;&#x65F6;&#x5C06;&#x88AB;&#x8C03;&#x7528;&#x7684;&#x51FD;&#x6570;&#x3002;<code>doSomething</code>&#x793A;&#x4F8B;&#x4E2D;&#x7684;&#x51FD;&#x6570;&#x5177;&#x6709;&#x53E6;&#x4E00;&#x4E2A;&#x53C2;&#x6570;<code>wait_time</code>&#x3002;</p>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> random
<span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> sleep

MESSAGE_CATEGORY = <span class="hljs-string">&apos;TaskFromFunction&apos;</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">doSomething</span><span class="hljs-params">(task, wait_time)</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot;
    Raises an exception to abort the task.
    Returns a result if success.
    The result will be passed, together with the exception (None in
    the case of success), to the on_finished method.
    If there is an exception, there will be no result.
    &quot;&quot;&quot;</span>
    QgsMessageLog.logMessage(<span class="hljs-string">&apos;Started task {}&apos;</span>.format(task.description()),
                             MESSAGE_CATEGORY, Qgis.Info)
    wait_time = wait_time / <span class="hljs-number">100</span>
    total = <span class="hljs-number">0</span>
    iterations = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">100</span>):
        sleep(wait_time)
        <span class="hljs-comment"># use task.setProgress to report progress</span>
        task.setProgress(i)
        arandominteger = random.randint(<span class="hljs-number">0</span>, <span class="hljs-number">500</span>)
        total += arandominteger
        iterations += <span class="hljs-number">1</span>
        <span class="hljs-comment"># check task.isCanceled() to handle cancellation</span>
        <span class="hljs-keyword">if</span> task.isCanceled():
            stopped(task)
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">None</span>
        <span class="hljs-comment"># raise an exception to abort the task</span>
        <span class="hljs-keyword">if</span> arandominteger == <span class="hljs-number">42</span>:
            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&apos;bad value!&apos;</span>)
    <span class="hljs-keyword">return</span> {<span class="hljs-string">&apos;total&apos;</span>: total, <span class="hljs-string">&apos;iterations&apos;</span>: iterations,
            <span class="hljs-string">&apos;task&apos;</span>: task.description()}

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">stopped</span><span class="hljs-params">(task)</span>:</span>
    QgsMessageLog.logMessage(
        <span class="hljs-string">&apos;Task &quot;{name}&quot; was canceled&apos;</span>.format(
            name=task.description()),
        MESSAGE_CATEGORY, Qgis.Info)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">completed</span><span class="hljs-params">(exception, result=None)</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot;This is called when doSomething is finished.
    Exception is not None if doSomething raises an exception.
    result is the return value of doSomething.&quot;&quot;&quot;</span>
    <span class="hljs-keyword">if</span> exception <span class="hljs-keyword">is</span> <span class="hljs-keyword">None</span>:
        <span class="hljs-keyword">if</span> result <span class="hljs-keyword">is</span> <span class="hljs-keyword">None</span>:
            QgsMessageLog.logMessage(
                <span class="hljs-string">&apos;Completed with no exception and no result &apos;</span>\
                <span class="hljs-string">&apos;(probably manually canceled by the user)&apos;</span>,
                MESSAGE_CATEGORY, Qgis.Warning)
        <span class="hljs-keyword">else</span>:
            QgsMessageLog.logMessage(
                <span class="hljs-string">&apos;Task {name} completed\n&apos;</span>
                <span class="hljs-string">&apos;Total: {total} ( with {iterations} &apos;</span>
                <span class="hljs-string">&apos;iterations)&apos;</span>.format(
                    name=result[<span class="hljs-string">&apos;task&apos;</span>],
                    total=result[<span class="hljs-string">&apos;total&apos;</span>],
                    iterations=result[<span class="hljs-string">&apos;iterations&apos;</span>]),
                MESSAGE_CATEGORY, Qgis.Info)
    <span class="hljs-keyword">else</span>:
        QgsMessageLog.logMessage(<span class="hljs-string">&quot;Exception: {}&quot;</span>.format(exception),
                                 MESSAGE_CATEGORY, Qgis.Critical)
        <span class="hljs-keyword">raise</span> exception

<span class="hljs-comment"># Creae a few tasks</span>
task1 = QgsTask.fromFunction(<span class="hljs-string">u&apos;Waste cpu 1&apos;</span>, doSomething,
                             on_finished=completed, wait_time=<span class="hljs-number">4</span>)
task2 = QgsTask.fromFunction(<span class="hljs-string">u&apos;Waste cpu 2&apos;</span>, dosomething,
                             on_finished=completed, wait_time=<span class="hljs-number">3</span>)
QgsApplication.taskManager().addTask(task1)
QgsApplication.taskManager().addTask(task2)
</code></pre>
<h3 id="1423-&#x5904;&#x7406;&#x7B97;&#x6CD5;&#x7684;&#x4EFB;&#x52A1;">14.2.3 &#x5904;&#x7406;&#x7B97;&#x6CD5;&#x7684;&#x4EFB;&#x52A1;</h3>
<p>&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x4F7F;&#x7528;&#x7B97;&#x6CD5;<a href="https://docs.qgis.org/3.4/en/docs/user_manual/processing_algs/qgis/vectorcreation.html#qgisrandompointsinextent" target="_blank">qgis&#xFF1A;randompointsinextent</a>&#x7684;&#x4EFB;&#x52A1;&#xFF0C;&#x5728;&#x6307;&#x5B9A;&#x8303;&#x56F4;&#x5185;&#x751F;&#x6210;50000&#x4E2A;&#x968F;&#x673A;&#x70B9;&#x3002;&#x7ED3;&#x679C;&#x4EE5;&#x5B89;&#x5168;&#x7684;&#x65B9;&#x5F0F;&#x6DFB;&#x52A0;&#x5230;&#x9879;&#x76EE;&#x4E2D;&#x3002;</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> partial
<span class="hljs-keyword">from</span> qgis.core <span class="hljs-keyword">import</span> (QgsTaskManager, QgsMessageLog,
                       QgsProcessingAlgRunnerTask, QgsApplication,
                       QgsProcessingContext, QgsProcessingFeedback,
                       QgsProject)

MESSAGE_CATEGORY = <span class="hljs-string">&apos;AlgRunnerTask&apos;</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">task_finished</span><span class="hljs-params">(context, successful, results)</span>:</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> successful:
        QgsMessageLog.logMessage(<span class="hljs-string">&apos;Task finished unsucessfully&apos;</span>,
                                 MESSAGE_CATEGORY, Qgis.Warning)
    output_layer = context.getMapLayer(results[<span class="hljs-string">&apos;OUTPUT&apos;</span>])
    <span class="hljs-comment"># because getMapLayer doesn&apos;t transfer ownership, the layer will</span>
    <span class="hljs-comment"># be deleted when context goes out of scope and you&apos;ll get a</span>
    <span class="hljs-comment"># crash.</span>
    <span class="hljs-comment"># takeMapLayer transfers ownership so it&apos;s then safe to add it</span>
    <span class="hljs-comment"># to the project and give the project ownership.</span>
    <span class="hljs-keyword">if</span> output_layer <span class="hljs-keyword">and</span> output_layer.isValid():
        QgsProject.instance().addMapLayer(
             context.takeResultLayer(output_layer.id()))

alg = QgsApplication.processingRegistry().algorithmById(
                                      <span class="hljs-string">u&apos;qgis:randompointsinextent&apos;</span>)
context = QgsProcessingContext()
feedback = QgsProcessingFeedback()
params = {
    <span class="hljs-string">&apos;EXTENT&apos;</span>: <span class="hljs-string">&apos;0.0,10.0,40,50 [EPSG:4326]&apos;</span>,
    <span class="hljs-string">&apos;MIN_DISTANCE&apos;</span>: <span class="hljs-number">0.0</span>,
    <span class="hljs-string">&apos;POINTS_NUMBER&apos;</span>: <span class="hljs-number">50000</span>,
    <span class="hljs-string">&apos;TARGET_CRS&apos;</span>: <span class="hljs-string">&apos;EPSG:4326&apos;</span>,
    <span class="hljs-string">&apos;OUTPUT&apos;</span>: <span class="hljs-string">&apos;memory:My random points&apos;</span>
}
task = QgsProcessingAlgRunnerTask(alg, params, context, feedback)
task.executed.connect(partial(task_finished, context))
QgsApplication.taskManager().addTask(task)
</code></pre>
<p>&#x4E5F;&#x53EF;&#x4EE5;&#x67E5;&#x770B;&#x535A;&#x5BA2;&#xFF1A;<a href="https://opengis.ch/2018/06/22/threads-in-pyqgis3/" target="_blank">https://opengis.ch/2018/06/22/threads-in-pyqgis3/</a></p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                
                <a href="15 任务 - 在后台做繁重的工作.html#151-引言" class="navigation navigation-next navigation-unique" aria-label="Next page: 15.1 引言">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"15 任务 - 在后台做繁重的工作","level":"1.16","depth":1,"next":{"title":"15.1 引言","level":"1.16.1","depth":2,"anchor":"#151-引言","path":"gitbook/15 任务 - 在后台做繁重的工作.md","ref":"gitbook/15 任务 - 在后台做繁重的工作.md#151-引言","articles":[]},"previous":{"title":"14.5 Authentication GUIs","level":"1.15.5","depth":2,"anchor":"#id24","url":"https://docs.qgis.org/testing/en/docs/pyqgis_developer_cookbook/authentication.html#id24","ref":"https://docs.qgis.org/testing/en/docs/pyqgis_developer_cookbook/authentication.html#id24","articles":[]},"dir":"ltr"},"config":{"plugins":["-lunr","-search","search-pro","-sharing","chapter-fold","github","splitter","code","back-to-top-button","hide-element","donate","auto-scroll-table","lightbox","custom-favicon","pageview-count"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"chapter-fold":{},"github":{"url":"https://github.com/luolingchun/PyQGIS-Developer-Cookbook-cn"},"splitter":{},"search-pro":{},"auto-scroll-table":{},"code":{"copyButtons":true},"donate":{"alipay":"https://raw.githubusercontent.com/luolingchun/luolingchun.github.io/master/gitbook/images/alipay.jpg","alipayText":"支付宝打赏","button":"赏","title":"","wechat":"https://raw.githubusercontent.com/luolingchun/luolingchun.github.io/master/gitbook/images/wechat.jpg","wechatText":"微信打赏"},"hide-element":{"elements":[".gitbook-link"]},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"favicon":"./gitbook/images/favicon.ico","lightbox":{"jquery":true,"sameUuid":false},"back-to-top-button":{},"pageview-count":{},"custom-favicon":{},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"llc","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"PYQGIS开发者手册-中文","language":"zh-hans","gitbook":"*","description":"PYQGIS开发者手册中文翻译"},"file":{"path":"gitbook/15 任务 - 在后台做繁重的工作.md","mtime":"2021-02-17T04:08:29.656Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2021-03-14T05:55:37.832Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook.js"></script>
    <script src="theme.js"></script>
    
        
        <script src="gitbook-plugin-search-pro/jquery.mark.min.js"></script>
        
    
        
        <script src="gitbook-plugin-search-pro/search.js"></script>
        
    
        
        <script src="gitbook-plugin-chapter-fold/chapter-fold.js"></script>
        
    
        
        <script src="gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="gitbook-plugin-code/plugin.js"></script>
        
    
        
        <script src="gitbook-plugin-back-to-top-button/plugin.js"></script>
        
    
        
        <script src="gitbook-plugin-hide-element/plugin.js"></script>
        
    
        
        <script src="gitbook-plugin-donate/plugin.js"></script>
        
    
        
        <script src="gitbook-plugin-auto-scroll-table/plugin.js"></script>
        
    
        
        <script src="gitbook-plugin-lightbox/js/lightbox.min.js"></script>
        
    
        
        <script src="gitbook-plugin-pageview-count/plugin.js"></script>
        
    
        
        <script src="gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

